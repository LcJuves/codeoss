# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: CodeOSS CI

on:
  push:
    branches:
      - dev/*
    tags:
      - v*.*.*
  pull_request:
    branches:
      - $default-branch

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PYTHON_VERSION: "3.x"
  RUST_VERSION: 1.88
  CARGO_TERM_COLOR: always
  CODE_ICO_URL: https://github.com/LcJuves/vscode/raw/94cba4eb314f52fd18b47b72459954fda65302d0/resources/win32/code.ico
  VSCODE_STEP_ON_IT: false
  CACHE_VERSION: 1766772970
  PUBLISH_NAME: dev_pre_part46
  PUBLISH_TAG_NAME: dev_pre_part46
  PRE_RELEASE: true
  MAKE_LATEST: legacy
  VSCODE_QUALITY: stable

defaults:
  run:
    shell: bash

jobs:
  generate-product-configurations:
    name: Generate product configurations
    runs-on: windows-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: x64
    outputs:
      application-name: ${{ steps.write-job-variables.outputs.application-name }}
      tunnel-application-name: ${{ steps.write-job-variables.outputs.tunnel-application-name }}
      name-short: ${{ steps.write-job-variables.outputs.name-short }}
      name-long: ${{ steps.write-job-variables.outputs.name-long }}
      version: ${{ steps.write-job-variables.outputs.version }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Compute product configurations cache key
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: compute-product-configurations-cache-key
        run: |
          GITHUB_API_URL=https://api.github.com/repos/microsoft/vscode/releases
          curl -H "Accept: application/vnd.github.v3+json" -s $GITHUB_API_URL >releases.json
          # shellcheck disable=SC2034
          REMOTE_VERSION=$(node -p "require('./releases.json')[0]['tag_name']")
          VERSION=$(node -p "require('./package.json')['version']")
          echo "VERSION=$VERSION" >>"$GITHUB_ENV"

          UNIVERSAL_ZIP_VERSION=$VERSION
          [ "$GITHUB_REF_NAME" == "dev/real-time-synchronization" ] && UNIVERSAL_ZIP_VERSION=$REMOTE_VERSION
          VS_ZIP_URL="https://update.code.visualstudio.com/${UNIVERSAL_ZIP_VERSION}/darwin-universal/stable"
          CURL_DO_URL=$(curl -is "$VS_ZIP_URL" | grep Location | awk -F ": " '{print $2}' | tr -d "\r|\n")
          echo "CURL_DO_URL=$CURL_DO_URL" >>"$GITHUB_ENV"
          echo "key=$(echo "$CURL_DO_URL#$CACHE_VERSION" | sha512sum | awk '{print $1}')" >>"$GITHUB_OUTPUT"

      - name: Cache product configurations
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: cache-product-configurations
        uses: actions/cache@v5
        with:
          path: |
            product.json
            vs-product.json
            resources/win32/VisualElementsManifest.xml
            resources/server/manifest.json
            resources/linux/AppImage.yml
          key: ${{ steps.compute-product-configurations-cache-key.outputs.key }}

      - name: Do generating ...
        if: ${{ steps.cache-product-configurations.outputs.cache-hit != 'true' }}
        run: |
          VS_ZIP_NAME="VSCode-darwin-universal.zip"
          curl -L -s -o $VS_ZIP_NAME "$CURL_DO_URL"
          VS_PRODUCT_JSON_PATH="Visual Studio Code.app/Contents/Resources/app/product.json"
          unzip $VS_ZIP_NAME "$VS_PRODUCT_JSON_PATH"
          cp "$VS_PRODUCT_JSON_PATH" vs-product.json
          node .github/generateProductConfigurations.mjs

      - name: Publish product configurations
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/upload-artifact@v6
        with:
          name: Product configurations
          path: |
            product.json
            vs-product.json
            package.json
            resources/win32/VisualElementsManifest.xml
            resources/server/manifest.json
            resources/linux/AppImage.yml

      - name: Write job variables
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: write-job-variables
        run: |
          echo "application-name=$(node -p "require('./product.json')['applicationName']")" >>"$GITHUB_OUTPUT"
          echo "tunnel-application-name=$(node -p "require('./product.json')['tunnelApplicationName']")" >>"$GITHUB_OUTPUT"
          echo "name-short=$(node -p "require('./product.json')['nameShort']")" >>"$GITHUB_OUTPUT"
          echo "name-long=$(node -p "require('./product.json')['nameLong']")" >>"$GITHUB_OUTPUT"
          echo "version=$VERSION" >>"$GITHUB_OUTPUT"

  compile:
    name: Compile
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: x64
    env:
      OPENSSL_PREBUILT_VERSION: 0.0.11

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Compute node modules cache key
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: compute-node-modules-cache-key
        run: echo "key=$(node build/azure-pipelines/common/computeNodeModulesCacheKey.ts compile)" >>"$GITHUB_OUTPUT"

      - name: Cache node modules
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: cache-node-modules
        uses: actions/cache@v5
        with:
          path: ".build/node_modules_cache"
          key: "NodeModules${{ steps.compute-node-modules-cache-key.outputs.key }}${{ env.CACHE_VERSION }}"

      - name: Extract node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit == 'true' }}
        run: tar -xJf .build/node_modules_cache/cache.tar.xz

      - name: Install build tools
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          sudo apt update -y
          sudo apt install -y build-essential pkg-config libx11-dev libx11-xcb-dev libxkbfile-dev libnotify-bin libkrb5-dev

      - name: Install dependencies
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          for i in {1..5}; do # try 5 times
            npm ci && break
            if [ $i -eq 5 ]; then
              echo "Npm install failed too many times" >&2
              exit 1
            fi
            echo "Npm install failed $i, trying again..."
          done
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Mixin distro node modules
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: node build/azure-pipelines/distro/mixin-npm.ts

      - name: Create node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p .build/node_modules_cache
          node build/azure-pipelines/common/listNodeModules.ts .build/node_modules_list.txt
          tar -cJf .build/node_modules_cache/cache.tar.xz -T .build/node_modules_list.txt

      - name: Install built-in extensions
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: ./.github/workflows/install-builtin-extensions
        with:
          cache-version: ${{ env.CACHE_VERSION }}

      - name: Compile & Hygiene
        if: ${{ endsWith(github.repository, 'codeoss') }}
        timeout-minutes: 300
        run: |
          npm exec -- npm-run-all -lp \
              core-ci-pr extensions-ci-pr hygiene eslint \
              valid-layers-check define-class-fields-check vscode-dts-compile-check \
              tsec-compile-check test-build-scripts

      - name: Compute openssl prebuilt cache key
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: compute-openssl-prebuilt-cache-key
        run: echo "key=$(echo "OPENSSL_PREBUILT#$OPENSSL_PREBUILT_VERSION#$CACHE_VERSION" | sha512sum | awk '{print $1}')" >>"$GITHUB_OUTPUT"

      - name: Cache openssl prebuilt
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: cache-openssl-prebuilt
        uses: actions/cache@v5
        with:
          path: |
            openssl
            package/out
          key: ${{ steps.compute-openssl-prebuilt-cache-key.outputs.key }}

      - name: Extract openssl prebuilt
        if: ${{ steps.cache-openssl-prebuilt.outputs.cache-hit != 'true' }}
        run: |
          npm pack @vscode/openssl-prebuilt@$OPENSSL_PREBUILT_VERSION
          mkdir openssl
          tar -xvzf vscode-openssl-prebuilt-$OPENSSL_PREBUILT_VERSION.tgz --strip-components=2 -C openssl package/out

      - name: Compress compilation artifact
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          tar -cvJ --ignore-failed-read \
              --exclude='.build/node_modules_cache' \
              --exclude='.build/node_modules_list.txt' \
              --exclude='.build/distro' \
              -f compilation.tar.xz \
              $(ls -d .build out-* test/integration/browser/out test/smoke/out test/automation/out openssl package/out 2>/dev/null)

      - name: Publish compilation artifact
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/upload-artifact@v6
        with:
          name: Compilation
          path: compilation.tar.xz

  build-for-linux:
    name: Build for Linux
    runs-on: ubuntu-22.04 # ubuntu-latest
    needs: [generate-product-configurations, compile]
    continue-on-error: true
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: x64
            vscode-cli-target: x86_64-unknown-linux-gnu
          - arch: arm64
            vscode-cli-target: aarch64-unknown-linux-gnu
          - arch: armhf
            vscode-cli-target: armv7-unknown-linux-gnueabihf
    env:
      VSCODE_ARCH: ${{ matrix.arch }}
      APPLICATION_NAME: ${{ needs.generate-product-configurations.outputs.application-name }}
      CLI_APP_NAME: ${{ needs.generate-product-configurations.outputs.tunnel-application-name }}
      NAME_SHORT: ${{ needs.generate-product-configurations.outputs.name-short }}
      VERSION: ${{ needs.generate-product-configurations.outputs.version }}
      VSCODE_CLI_TARGET: ${{ matrix.vscode-cli-target }}
      VSCODE_CIBUILD: false

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
      - uses: MeyouOSS/ATiltedTree-setup-rust@v1.0.8
        with:
          rust-version: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.vscode-cli-target }}
          components: clippy

      - name: Initialize job variables
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          NPM_ARCH=$VSCODE_ARCH
          [ "${NPM_ARCH}" == "armhf" ] && NPM_ARCH=arm
          echo "NPM_ARCH=$NPM_ARCH" >>"$GITHUB_ENV"
          [ "$VSCODE_ARCH" == "x64" ] && echo "DISPLAY=:10" >>"$GITHUB_ENV"
          SYSROOT_ARCH=$VSCODE_ARCH
          if [ "$SYSROOT_ARCH" == "x64" ]; then
            SYSROOT_ARCH="amd64"
          fi
          echo "SYSROOT_ARCH=$SYSROOT_ARCH" >>"$GITHUB_ENV"
          OPENSSL_ARCH="${VSCODE_ARCH}"
          if [ "$OPENSSL_ARCH" == "armhf" ]; then
            OPENSSL_ARCH="arm"
          fi
          (echo "OPENSSL_ARCH=$OPENSSL_ARCH" >>"$GITHUB_ENV") || echo >/dev/null

      - name: Download product configurations
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/download-artifact@v7
        with:
          name: Product configurations

      - name: Download compilation output
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/download-artifact@v7
        with:
          name: Compilation

      - name: Extract compilation output
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: tar -xJf compilation.tar.xz

      - name: Setup system services
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          # Start X server
          ./build/azure-pipelines/linux/apt-retry.sh sudo apt-get update -y
          ./build/azure-pipelines/linux/apt-retry.sh sudo apt-get install -y pkg-config \
          	xvfb \
          	libgtk-3-0 \
          	libxkbfile-dev \
          	libkrb5-dev \
          	libgbm1 \
          	rpm
          sudo cp build/azure-pipelines/linux/xvfb.init /etc/init.d/xvfb
          sudo chmod +x /etc/init.d/xvfb
          sudo update-rc.d xvfb defaults
          sudo service xvfb start

      - name: Compute node modules cache key
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: compute-node-modules-cache-key
        run: echo "key=$(node build/azure-pipelines/common/computeNodeModulesCacheKey.ts linux $VSCODE_ARCH)" >>"$GITHUB_OUTPUT"

      - name: Cache node modules
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: cache-node-modules
        uses: actions/cache@v5
        with:
          path: ".build/node_modules_cache"
          key: "NodeModules${{ steps.compute-node-modules-cache-key.outputs.key }}${{ env.CACHE_VERSION }}"

      - name: Extract node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit == 'true' }}
        run: tar -xJf .build/node_modules_cache/cache.tar.xz

      - name: Install build dependencies
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          for i in {1..5}; do # try 5 times
            npm ci && break
            if [ $i -eq 5 ]; then
              echo "Npm install failed too many times" >&2
              exit 1
            fi
            echo "Npm install failed $i, trying again..."
          done
        working-directory: build

      - name: Download sysroots
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          export VSCODE_SYSROOT_DIR="$PWD"/.build/sysroots/glibc-2.28-gcc-8.5.0
          export VSCODE_SYSROOT_PREFIX="-glibc-2.28-gcc-8.5.0"
          node -e \
          	'import { getVSCodeSysroot } from "./build/linux/debian/install-sysroot.ts"; (async () => { await getVSCodeSysroot(process.env["SYSROOT_ARCH"]); })()'
      - name: Install dependencies
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          source ./build/azure-pipelines/linux/setup-env.sh

          # Run preinstall script before root dependencies are installed
          # so that v8 headers are patched correctly for native modules.
          node build/npm/preinstall.ts

          for i in {1..5}; do # try 5 times
          	npm ci && break
          	if [ "$i" -eq 5 ]; then
          		echo "Npm install failed too many times" >&2
          		exit 1
          	fi
          	echo "Npm install failed $i, trying again..."
          done
        env:
          npm_config_arch: ${{ env.NPM_ARCH }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Mixin distro node modules
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: node build/azure-pipelines/distro/mixin-npm.ts

      - name: Create node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p .build/node_modules_cache
          node build/azure-pipelines/common/listNodeModules.ts .build/node_modules_list.txt
          tar -cJf .build/node_modules_cache/cache.tar.xz -T .build/node_modules_list.txt

      - name: Install built-in extensions
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: ./.github/workflows/install-builtin-extensions
        with:
          cache-version: ${{ env.CACHE_VERSION }}

      - name: Generate policy definitions
        if: ${{ endsWith(github.repository, 'codeoss') && env.VSCODE_CIBUILD != true }}
        run: |
          for i in {1..3}; do # try 3 times
            (
              npm run copy-policy-dto --prefix build
              node build/lib/policies/policyGenerator.ts build/lib/policies/policyData.jsonc linux
            ) && break
            if [ "$i" -eq 3 ]; then
              exit 1
            fi
          done

      - name: Build client artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          BUILD_VERSION="$(date +%s)"
          DEFAULT_BUILD=VSCode-linux-${VSCODE_ARCH}
          BUILD=$NAME_SHORT-linux-${VSCODE_ARCH}
          echo "::group::Build binary package"
          npm run gulp vscode-linux-${VSCODE_ARCH}-min-ci
          echo "::group::Compile CLI ($VSCODE_CLI_TARGET)"
          export OPENSSL_LIB_DIR="$PWD/openssl/${OPENSSL_ARCH}-linux/lib"
          export OPENSSL_INCLUDE_DIR="$PWD/openssl/${OPENSSL_ARCH}-linux/include"
          cd cli || exit
          cargo build --release --target "$VSCODE_CLI_TARGET" --bin=code
          cd "$GITHUB_WORKSPACE" || exit
          mv cli/target/"$VSCODE_CLI_TARGET"/release/code ../$DEFAULT_BUILD/bin/"$CLI_APP_NAME"
          echo "::endgroup::"
          (cd .. && cp -r $DEFAULT_BUILD $BUILD)
          [ -z "${VSCODE_QUALITY}" ] &&
          	XZ_TARBALL_NAME="${APPLICATION_NAME}-${VSCODE_ARCH}-$BUILD_VERSION.tar.xz" ||
          	XZ_TARBALL_NAME="${APPLICATION_NAME}-${VSCODE_QUALITY}-${VSCODE_ARCH}-$BUILD_VERSION.tar.xz"
          (cd .. && tar -cJf "$XZ_TARBALL_NAME" $BUILD)
          mv ../"$XZ_TARBALL_NAME" .
          echo "XZ_TARBALL_NAME=$XZ_TARBALL_NAME" >>"$GITHUB_ENV"
          [ -z "${VSCODE_QUALITY}" ] &&
          	GZ_TARBALL_NAME="${APPLICATION_NAME}-${VSCODE_ARCH}-$BUILD_VERSION.tar.gz" ||
          	GZ_TARBALL_NAME="${APPLICATION_NAME}-${VSCODE_QUALITY}-${VSCODE_ARCH}-$BUILD_VERSION.tar.gz"
          (cd .. && tar -zcf "$GZ_TARBALL_NAME" $BUILD)
          mv ../"$GZ_TARBALL_NAME" .
          echo "GZ_TARBALL_NAME=$GZ_TARBALL_NAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          echo "::group::Prepare deb package"
          npm run gulp vscode-linux-${VSCODE_ARCH}-prepare-deb
          echo "::endgroup::"
          echo "::group::Build deb package"
          npm run gulp vscode-linux-${VSCODE_ARCH}-build-deb
          DEB_OUT=$(file $(ls .build/linux/deb/*/deb/*.deb))
          if [[ "$DEB_OUT" != *"data compression xz"* ]]; then
            echo "Error: unknown compression. $DEB_OUT"
            exit 1
          fi
          DEB_PATH="$(ls .build/linux/deb/*/deb/*.deb)"
          DEB_FILENAME="${DEB_PATH##*/}"
          mv "$DEB_PATH" .
          echo "DEB_FILENAME=$DEB_FILENAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          if [ "$VSCODE_ARCH" == "x64" ]; then
          	echo "::group::Build AppImage package"
          	npm install -g @liangchengj/nfserv && (nfserv >nfserv.log 2>&1 &) && (sleep 6 && cat nfserv.log)
          	DOWNLOAD_URL="http://127.0.0.1:9934/$DEB_FILENAME"
          	echo "DOWNLOAD_URL >>> $DOWNLOAD_URL" && export DOWNLOAD_URL
          	GITHUB_API_URL=https://api.github.com/repos/AppImage/pkg2appimage/releases
          	curl -H "Accept: application/vnd.github.v3+json" -s $GITHUB_API_URL >releases.json
          	BROWSER_DOWNLOAD_URL=$(node -p "require('./releases.json')[0]['assets'][0]['browser_download_url']")
          	curl -L -O -s "$BROWSER_DOWNLOAD_URL" && chmod u+x "$PWD/${BROWSER_DOWNLOAD_URL##*/}"
          	"$PWD/${BROWSER_DOWNLOAD_URL##*/}" "$APPIMAGE_YML_PATH"
          	APPIMAGE_FILENAME=$NAME_SHORT-linux-${VSCODE_ARCH}-$VERSION.AppImage
          	mv out/*.AppImage "$APPIMAGE_FILENAME"
          	echo "APPIMAGE_FILENAME=$APPIMAGE_FILENAME" >>"$GITHUB_ENV"
          	echo "::endgroup::"
          fi

          echo "::group::Prepare rpm package"
          TRIPLE=""
          if [ "$VSCODE_ARCH" == "x64" ]; then
            TRIPLE="x86_64-linux-gnu"
          elif [ "$VSCODE_ARCH" == "arm64" ]; then
            TRIPLE="aarch64-linux-gnu"
          elif [ "$VSCODE_ARCH" == "armhf" ]; then
            TRIPLE="arm-rpi-linux-gnueabihf"
          fi
          export VSCODE_SYSROOT_DIR="$PWD/.build/sysroots/glibc-2.28-gcc-10.5.0"
          export STRIP="$VSCODE_SYSROOT_DIR/$TRIPLE/$TRIPLE/bin/strip"
          npm run gulp vscode-linux-${VSCODE_ARCH}-prepare-rpm
          echo "::endgroup::"

          echo "::group::Build rpm package"
          npm run gulp vscode-linux-${VSCODE_ARCH}-build-rpm
          RPM_PATH="$(ls .build/linux/rpm/*/*.rpm)"
          RPM_FILENAME="${RPM_PATH##*/}"
          mv "$RPM_PATH" .
          echo "RPM_FILENAME=$RPM_FILENAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          echo "::group::Build snap package"
          npm run gulp "vscode-linux-${VSCODE_ARCH}-prepare-snap"
          sudo -E docker run -e VSCODE_ARCH -e VSCODE_QUALITY -v "$PWD":/work -w /work \
          	vscodehub.azurecr.io/vscode-linux-build-agent:snapcraft-x64 /bin/bash -c \
          	"./build/azure-pipelines/linux/build-snap.sh"

          SNAP_ROOT="$PWD/.build/linux/snap/${VSCODE_ARCH}"
          SNAP_EXTRACTED_PATH=$(find "$SNAP_ROOT" -maxdepth 1 -type d -name 'code-*')

          mkdir -p .build/linux/snap
          # shellcheck disable=SC2046
          cp $(find "$SNAP_ROOT" -maxdepth 1 -type f -name '*.snap') .build/linux/snap/

          # SBOM tool doesn't like recursive symlinks
          sudo find "$SNAP_EXTRACTED_PATH" -type l -delete

          SNAP_PATH="$(ls .build/linux/snap/*.snap)"

          # SNAP_PATH is the path to the snap file in the snapcraft build environment
          echo "SNAP_PATH=$SNAP_PATH" >>"$GITHUB_ENV"
          SNAP_FINALLY_FILENAME="$APPLICATION_NAME-$VSCODE_QUALITY-$VSCODE_ARCH-$BUILD_VERSION.snap"
          echo "SNAP_FINALLY_FILENAME=$SNAP_FINALLY_FILENAME" >>"$GITHUB_ENV"
          mv "$SNAP_PATH" ./$SNAP_FINALLY_FILENAME
          echo "::endgroup::"

      - name: Build server artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          echo "::group::Build server"
          npm run gulp vscode-reh-linux-${VSCODE_ARCH}-min-ci
          SERVER_BUILD_NAME="$APPLICATION_NAME-server-linux-${VSCODE_ARCH}"
          (cd .. && cp -r vscode-reh-linux-${VSCODE_ARCH} $SERVER_BUILD_NAME)
          SERVER_XZ_TARBALL_FILENAME="$SERVER_BUILD_NAME.tar.xz"
          (cd .. && tar -cJf $SERVER_XZ_TARBALL_FILENAME $SERVER_BUILD_NAME)
          mv ../$SERVER_XZ_TARBALL_FILENAME .
          echo "SERVER_XZ_TARBALL_FILENAME=$SERVER_XZ_TARBALL_FILENAME" >>"$GITHUB_ENV"
          SERVER_GZ_TARBALL_FILENAME="$SERVER_BUILD_NAME.tar.gz"
          (cd .. && tar -zcf $SERVER_GZ_TARBALL_FILENAME $SERVER_BUILD_NAME)
          mv ../$SERVER_GZ_TARBALL_FILENAME .
          echo "SERVER_GZ_TARBALL_FILENAME=$SERVER_GZ_TARBALL_FILENAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          echo "::group::Build server (web)"
          npm run gulp vscode-reh-web-linux-${VSCODE_ARCH}-min-ci
          SERVER_WEB_BUILD_NAME="$APPLICATION_NAME-server-linux-${VSCODE_ARCH}-web"
          (cd .. && cp -r vscode-reh-web-linux-${VSCODE_ARCH} $SERVER_WEB_BUILD_NAME)
          SERVER_WEB_XZ_TARBALL_FILENAME="$SERVER_WEB_BUILD_NAME.tar.xz"
          (cd .. && tar -cJf $SERVER_WEB_XZ_TARBALL_FILENAME $SERVER_WEB_BUILD_NAME)
          mv ../$SERVER_WEB_XZ_TARBALL_FILENAME .
          echo "SERVER_WEB_XZ_TARBALL_FILENAME=$SERVER_WEB_XZ_TARBALL_FILENAME" >>"$GITHUB_ENV"
          SERVER_WEB_GZ_TARBALL_FILENAME="$SERVER_WEB_BUILD_NAME.tar.gz"
          (cd .. && tar -zcf $SERVER_WEB_GZ_TARBALL_FILENAME $SERVER_WEB_BUILD_NAME)
          mv ../$SERVER_WEB_GZ_TARBALL_FILENAME .
          echo "SERVER_WEB_GZ_TARBALL_FILENAME=$SERVER_WEB_GZ_TARBALL_FILENAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          echo "::group::Check GLIBC and GLIBCXX dependencies in server archive"
          SEARCH_PATH=$(cd ../$SERVER_BUILD_NAME && pwd)
          if [[ $VSCODE_ARCH == 'x64' || $VSCODE_ARCH == 'arm64' ]]; then
          	EXPECTED_GLIBC_VERSION="2.28" \
                  EXPECTED_GLIBCXX_VERSION="3.4.25" \
                  VSCODE_SYSROOT_DIR="$PWD/.build/sysroots/glibc-2.28-gcc-8.5.0" \
                  ./build/azure-pipelines/linux/verify-glibc-requirements.sh
          else
          	EXPECTED_GLIBC_VERSION="2.28" \
                  EXPECTED_GLIBCXX_VERSION="3.4.26" \
                  VSCODE_SYSROOT_DIR="$PWD/.build/sysroots/glibc-2.28-gcc-8.5.0" \
                  ./build/azure-pipelines/linux/verify-glibc-requirements.sh
          fi
          echo "::endgroup::"

      - name: Generate SHA512 checksum files
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          gensha512() { (sha512sum "$1" | awk '{print $1}' >"$1".sha512); }
          [ -f "$XZ_TARBALL_NAME" ] && gensha512 "$XZ_TARBALL_NAME"
          [ -f "$GZ_TARBALL_NAME" ] && gensha512 "$GZ_TARBALL_NAME"
          [ -f "$DEB_FILENAME" ] && gensha512 "$DEB_FILENAME"
          [ -f "$APPIMAGE_FILENAME" ] && gensha512 "$APPIMAGE_FILENAME"
          [ -f "$RPM_FILENAME" ] && gensha512 "$RPM_FILENAME"
          [ -f "$SNAP_FINALLY_FILENAME" ] && gensha512 "$SNAP_FINALLY_FILENAME"
          [ -f "$SERVER_XZ_TARBALL_FILENAME" ] && gensha512 "$SERVER_XZ_TARBALL_FILENAME"
          [ -f "$SERVER_GZ_TARBALL_FILENAME" ] && gensha512 "$SERVER_GZ_TARBALL_FILENAME"
          [ -f "$SERVER_WEB_XZ_TARBALL_FILENAME" ] && gensha512 "$SERVER_WEB_XZ_TARBALL_FILENAME"
          ([ -f "$SERVER_WEB_GZ_TARBALL_FILENAME" ] && gensha512 "$SERVER_WEB_GZ_TARBALL_FILENAME") || echo >/dev/null

      - name: Switch to tag name
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          echo "PUBLISH_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PUBLISH_TAG_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PRE_RELEASE=false" >>"$GITHUB_ENV"

      - name: Publish artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: softprops/action-gh-release@v2.5.0
        with:
          name: ${{ env.PUBLISH_NAME }}
          tag_name: ${{ env.PUBLISH_TAG_NAME }}
          prerelease: ${{ env.PRE_RELEASE }}
          make_latest: ${{ env.MAKE_LATEST }}
          target_commitish: ${{ env.GITHUB_WORKFLOW_SHA }}
          files: |
            ${{ env.XZ_TARBALL_NAME }}
            ${{ env.XZ_TARBALL_NAME }}.sha512
            ${{ env.GZ_TARBALL_NAME }}
            ${{ env.GZ_TARBALL_NAME }}.sha512
            ${{ env.RPM_FILENAME }}
            ${{ env.RPM_FILENAME }}.sha512
            ${{ env.DEB_FILENAME }}
            ${{ env.DEB_FILENAME }}.sha512
            ${{ env.SNAP_FINALLY_FILENAME }}
            ${{ env.SNAP_FINALLY_FILENAME }}.sha512
            ${{ env.APPIMAGE_FILENAME }}
            ${{ env.APPIMAGE_FILENAME }}.sha512
            ${{ env.SERVER_GZ_TARBALL_FILENAME }}
            ${{ env.SERVER_GZ_TARBALL_FILENAME }}.sha512
            ${{ env.SERVER_XZ_TARBALL_FILENAME }}
            ${{ env.SERVER_XZ_TARBALL_FILENAME }}.sha512
            ${{ env.SERVER_WEB_GZ_TARBALL_FILENAME }}
            ${{ env.SERVER_WEB_GZ_TARBALL_FILENAME }}.sha512
            ${{ env.SERVER_WEB_XZ_TARBALL_FILENAME }}
            ${{ env.SERVER_WEB_XZ_TARBALL_FILENAME }}.sha512

  build-for-macos:
    name: Build for macOS
    runs-on: macos-15
    needs: [generate-product-configurations, compile]
    continue-on-error: true
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: x64
            vscode-cli-target-arch: x86_64
          - arch: arm64
            vscode-cli-target-arch: aarch64
    env:
      VSCODE_ARCH: ${{ matrix.arch }}
      APPLICATION_NAME: ${{ needs.generate-product-configurations.outputs.application-name }}
      CLI_APP_NAME: ${{ needs.generate-product-configurations.outputs.tunnel-application-name }}
      NAME_SHORT: ${{ needs.generate-product-configurations.outputs.name-short }}
      NAME_LONG: ${{ needs.generate-product-configurations.outputs.name-long }}
      VSCODE_CLI_TARGET: ${{ matrix.vscode-cli-target-arch }}-apple-darwin

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
      - uses: MeyouOSS/ATiltedTree-setup-rust@v1.0.8
        with:
          rust-version: ${{ env.RUST_VERSION }}
          targets: ${{ env.VSCODE_CLI_TARGET }}
          components: clippy

      - name: Download product configurations
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/download-artifact@v7
        with:
          name: Product configurations

      - name: Download compilation output
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/download-artifact@v7
        with:
          name: Compilation

      - name: Extract compilation output
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: tar -xJf compilation.tar.xz

      - name: Compute node modules cache key
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: compute-node-modules-cache-key
        run: echo "key=$(node build/azure-pipelines/common/computeNodeModulesCacheKey.ts darwin $VSCODE_ARCH)" >>"$GITHUB_OUTPUT"

      - name: Cache node modules
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: cache-node-modules
        uses: actions/cache@v5
        with:
          path: ".build/node_modules_cache"
          key: "NodeModules${{ steps.compute-node-modules-cache-key.outputs.key }}${{ env.CACHE_VERSION }}"

      - name: Extract node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit == 'true' }}
        run: tar -xJf .build/node_modules_cache/cache.tar.xz

      - name: Install dependencies
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          for i in {1..5}; do # try 5 times
            npm ci && break
            if [ $i -eq 5 ]; then
              echo "Npm install failed too many times" >&2
              exit 1
            fi
            echo "Npm install failed $i, trying again..."
          done
        env:
          npm_config_arch: ${{ env.VSCODE_ARCH }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          # Avoid using dlopen to load Kerberos on macOS which can cause missing libraries
          # https://github.com/mongodb-js/kerberos/commit/04044d2814ad1d01e77f1ce87f26b03d86692cf2
          # flipped the default to support legacy linux distros which shouldn't happen
          # on macOS.
          GYP_DEFINES: "kerberos_use_rtld=false"

      - name: Create node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p .build/node_modules_cache
          node build/azure-pipelines/common/listNodeModules.ts .build/node_modules_list.txt
          tar -cJf .build/node_modules_cache/cache.tar.xz -T .build/node_modules_list.txt

      - name: Install built-in extensions
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: ./.github/workflows/install-builtin-extensions
        with:
          cache-version: ${{ env.CACHE_VERSION }}

      - name: Build client artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          npm run gulp vscode-darwin-${VSCODE_ARCH}-min-ci
          DEFAULT_BUILD=VSCode-darwin-${VSCODE_ARCH}
          BUILD=$NAME_SHORT-darwin-${VSCODE_ARCH}
          APP_NAME="${NAME_LONG}.app"
          echo "APP_NAME=$APP_NAME" >>"$GITHUB_ENV"
          export OPENSSL_LIB_DIR="$PWD/openssl/${VSCODE_ARCH}-osx/lib"
          export OPENSSL_INCLUDE_DIR="$PWD/openssl/${VSCODE_ARCH}-osx/include"
          (cd cli && cargo build --release --target "$VSCODE_CLI_TARGET" --bin=code)
          mv cli/target/"$VSCODE_CLI_TARGET"/release/code ../$DEFAULT_BUILD/"$APP_NAME"/Contents/Resources/app/bin/"$CLI_APP_NAME"
          (cd .. && cp -r $DEFAULT_BUILD $BUILD)
          APP_ROOT="$(cd ../$BUILD && pwd)"
          echo "APP_ROOT=$APP_ROOT" >>"$GITHUB_ENV"
          XZ_TARBALL_NAME=$BUILD.tar.xz
          (cd ../$BUILD && tar -cJf $XZ_TARBALL_NAME "$APP_NAME")
          mv ../$BUILD/$XZ_TARBALL_NAME .
          echo "XZ_TARBALL_NAME=$XZ_TARBALL_NAME" >>"$GITHUB_ENV"
          GZ_TARBALL_NAME=$BUILD.tar.gz
          (cd ../$BUILD && tar -zcf $GZ_TARBALL_NAME "$APP_NAME")
          mv ../$BUILD/$GZ_TARBALL_NAME .
          echo "GZ_TARBALL_NAME=$GZ_TARBALL_NAME" >>"$GITHUB_ENV"
          ZIP_NAME=$BUILD.zip
          (cd ../$BUILD && zip -Xry -q $ZIP_NAME "$APP_NAME")
          mv ../$BUILD/$ZIP_NAME .
          echo "ZIP_NAME=$ZIP_NAME" >>"$GITHUB_ENV"
        env:
          VSCODE_CLI_COMMIT: ${{ env.GITHUB_WORKFLOW_SHA }}

      - name: Build server artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          echo "::group::Build server"
          npm run gulp vscode-reh-darwin-$VSCODE_ARCH-min-ci
          SERVER_BUILD_NAME="$APPLICATION_NAME-server-darwin-$VSCODE_ARCH"
          (cd .. && cp -r vscode-reh-darwin-$VSCODE_ARCH $SERVER_BUILD_NAME)
          SERVER_APP_ROOT="$(cd ../$SERVER_BUILD_NAME && pwd)"
          echo "SERVER_APP_ROOT=$SERVER_APP_ROOT" >>"$GITHUB_ENV"
          SERVER_XZ_TARBALL_NAME="$SERVER_BUILD_NAME.tar.xz"
          (cd .. && tar -cJf $SERVER_XZ_TARBALL_NAME $SERVER_BUILD_NAME)
          mv ../$SERVER_XZ_TARBALL_NAME .
          echo "SERVER_XZ_TARBALL_NAME=$SERVER_XZ_TARBALL_NAME" >>"$GITHUB_ENV"
          SERVER_GZ_TARBALL_NAME="$SERVER_BUILD_NAME.tar.gz"
          (cd .. && tar -zcf $SERVER_GZ_TARBALL_NAME $SERVER_BUILD_NAME)
          mv ../$SERVER_GZ_TARBALL_NAME .
          echo "SERVER_GZ_TARBALL_NAME=$SERVER_GZ_TARBALL_NAME" >>"$GITHUB_ENV"
          SERVER_ZIP_NAME="$SERVER_BUILD_NAME.zip"
          (cd .. && zip -Xry -q $SERVER_ZIP_NAME $SERVER_BUILD_NAME)
          mv ../$SERVER_ZIP_NAME .
          echo "SERVER_ZIP_NAME=$SERVER_ZIP_NAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          echo "::group::Build server (web)"
          npm run gulp vscode-reh-web-darwin-$VSCODE_ARCH-min-ci
          SERVER_WEB_BUILD_NAME="$APPLICATION_NAME-server-darwin-$VSCODE_ARCH-web"
          (cd .. && cp -r vscode-reh-web-darwin-$VSCODE_ARCH $SERVER_WEB_BUILD_NAME)
          SERVER_WEB_XZ_TARBALL_NAME="$SERVER_WEB_BUILD_NAME.tar.xz"
          (cd .. && tar -cJf $SERVER_WEB_XZ_TARBALL_NAME $SERVER_WEB_BUILD_NAME)
          mv ../$SERVER_WEB_XZ_TARBALL_NAME .
          echo "SERVER_WEB_XZ_TARBALL_NAME=$SERVER_WEB_XZ_TARBALL_NAME" >>"$GITHUB_ENV"
          SERVER_WEB_GZ_TARBALL_NAME="$SERVER_WEB_BUILD_NAME.tar.gz"
          (cd .. && tar -zcf $SERVER_WEB_GZ_TARBALL_NAME $SERVER_WEB_BUILD_NAME)
          mv ../$SERVER_WEB_GZ_TARBALL_NAME .
          echo "SERVER_WEB_GZ_TARBALL_NAME=$SERVER_WEB_GZ_TARBALL_NAME" >>"$GITHUB_ENV"
          SERVER_WEB_ZIP_NAME="$SERVER_WEB_BUILD_NAME.zip"
          (cd .. && zip -Xry -q $SERVER_WEB_ZIP_NAME $SERVER_WEB_BUILD_NAME)
          mv ../$SERVER_WEB_ZIP_NAME .
          echo "SERVER_WEB_ZIP_NAME=$SERVER_WEB_ZIP_NAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

      - name: Verify arch of Mach-O objects
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          APP_PATH="$APP_ROOT/$APP_NAME" node build/darwin/verify-macho.ts "$VSCODE_ARCH"
          APP_PATH="$SERVER_APP_ROOT" node build/darwin/verify-macho.ts "$VSCODE_ARCH"

      - name: Generate SHA512 checksum files
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          gensha512() { (shasum -a 512 "$1" | awk '{print $1}' >"$1".sha512); }
          [ -f "$XZ_TARBALL_NAME" ] && gensha512 "$XZ_TARBALL_NAME"
          [ -f "$GZ_TARBALL_NAME" ] && gensha512 "$GZ_TARBALL_NAME"
          [ -f "$ZIP_NAME" ] && gensha512 "$ZIP_NAME"
          [ -f "$SERVER_XZ_TARBALL_NAME" ] && gensha512 "$SERVER_XZ_TARBALL_NAME"
          [ -f "$SERVER_GZ_TARBALL_NAME" ] && gensha512 "$SERVER_GZ_TARBALL_NAME"
          [ -f "$SERVER_ZIP_NAME" ] && gensha512 "$SERVER_ZIP_NAME"
          [ -f "$SERVER_WEB_XZ_TARBALL_NAME" ] && gensha512 "$SERVER_WEB_XZ_TARBALL_NAME"
          [ -f "$SERVER_WEB_GZ_TARBALL_NAME" ] && gensha512 "$SERVER_WEB_GZ_TARBALL_NAME"
          [ -f "$SERVER_WEB_ZIP_NAME" ] && gensha512 "$SERVER_WEB_ZIP_NAME"

      - name: Switch to tag name
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          echo "PUBLISH_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PUBLISH_TAG_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PRE_RELEASE=false" >>"$GITHUB_ENV"

      - name: Publish artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: softprops/action-gh-release@v2.5.0
        with:
          name: ${{ env.PUBLISH_NAME }}
          tag_name: ${{ env.PUBLISH_TAG_NAME }}
          prerelease: ${{ env.PRE_RELEASE }}
          make_latest: ${{ env.MAKE_LATEST }}
          target_commitish: ${{ env.GITHUB_WORKFLOW_SHA }}
          files: |
            ${{ env.XZ_TARBALL_NAME }}
            ${{ env.XZ_TARBALL_NAME }}.sha512
            ${{ env.GZ_TARBALL_NAME }}
            ${{ env.GZ_TARBALL_NAME }}.sha512
            ${{ env.ZIP_NAME }}
            ${{ env.ZIP_NAME }}.sha512
            ${{ env.SERVER_XZ_TARBALL_NAME }}
            ${{ env.SERVER_XZ_TARBALL_NAME }}.sha512
            ${{ env.SERVER_GZ_TARBALL_NAME }}
            ${{ env.SERVER_GZ_TARBALL_NAME }}.sha512
            ${{ env.SERVER_ZIP_NAME }}
            ${{ env.SERVER_ZIP_NAME }}.sha512
            ${{ env.SERVER_WEB_XZ_TARBALL_NAME }}
            ${{ env.SERVER_WEB_XZ_TARBALL_NAME }}.sha512
            ${{ env.SERVER_WEB_ZIP_NAME }}
            ${{ env.SERVER_WEB_ZIP_NAME }}.sha512

  build-macos-universal-application:
    name: Build macOS universal application
    runs-on: macos-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: arm64
    needs: [generate-product-configurations, build-for-macos]
    env:
      VSCODE_ARCH: universal
      NAME_SHORT: ${{ needs.generate-product-configurations.outputs.name-short }}
      NAME_LONG: ${{ needs.generate-product-configurations.outputs.name-long }}
      GITHUB_REPOSITORY: ${{ github.repository }}

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Download product configurations
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/download-artifact@v7
        with:
          name: Product configurations

      - name: Install build dependencies
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          for i in {1..5}; do # try 5 times
            npm ci && break
            if [ $i -eq 5 ]; then
              echo "Npm install failed too many times" >&2
              exit 1
            fi
            echo "Npm install failed $i, trying again..."
          done
        working-directory: build

      - name: Create Universal App
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          AGENT_BUILDDIRECTORY="$(cd .. && pwd)"
          DOWNLOAD_URL_PREFIX="https://github.com/$GITHUB_REPOSITORY/releases/download/$PUBLISH_TAG_NAME"
          curl -L -O -s "$DOWNLOAD_URL_PREFIX/$NAME_SHORT-darwin-arm64.tar.xz"
          curl -L -O -s "$DOWNLOAD_URL_PREFIX/$NAME_SHORT-darwin-x64.tar.xz"
          tar -xJf "$NAME_SHORT-darwin-arm64.tar.xz"
          mkdir ../VSCode-darwin-arm64 && mv ./*.app ../VSCode-darwin-arm64/
          tar -xJf "$NAME_SHORT-darwin-x64.tar.xz"
          mkdir ../VSCode-darwin-x64 && mv ./*.app ../VSCode-darwin-x64/
          DEBUG=* node build/darwin/create-universal-app.ts "$AGENT_BUILDDIRECTORY"
          BUILD=$NAME_SHORT-darwin-${VSCODE_ARCH}
          APP_NAME="${NAME_LONG}.app"
          echo "APP_NAME=$APP_NAME" >>"$GITHUB_ENV"
          (cd .. && cp -r VSCode-darwin-${VSCODE_ARCH} $BUILD)
          APP_ROOT="$(cd ../$BUILD && pwd)"
          echo "APP_ROOT=$APP_ROOT" >>"$GITHUB_ENV"
          XZ_TARBALL_NAME=$BUILD.tar.xz
          (cd ../$BUILD && tar -cJf ../$XZ_TARBALL_NAME ./*.app)
          mv ../$XZ_TARBALL_NAME .
          GZ_TARBALL_NAME=$BUILD.tar.gz
          (cd ../$BUILD && tar -czf ../$GZ_TARBALL_NAME ./*.app)
          mv ../$GZ_TARBALL_NAME .
          echo "GZ_TARBALL_NAME=$GZ_TARBALL_NAME" >>"$GITHUB_ENV"
          echo "XZ_TARBALL_NAME=$XZ_TARBALL_NAME" >>"$GITHUB_ENV"
          ZIP_NAME=$BUILD.zip
          (cd ../$BUILD && zip -r -X -y -q ../$ZIP_NAME ./*.app)
          mv ../$ZIP_NAME .
          echo "ZIP_NAME=$ZIP_NAME" >>"$GITHUB_ENV"

      - name: Verify arch of Mach-O objects
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: APP_PATH="$APP_ROOT/$APP_NAME" node build/darwin/verify-macho.ts "$VSCODE_ARCH"

      - name: Generate SHA512 checksum files
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          gensha512() { (shasum -a 512 "$1" | awk '{print $1}' >"$1".sha512); }
          [ -f "$XZ_TARBALL_NAME" ] && gensha512 "$XZ_TARBALL_NAME"
          [ -f "$GZ_TARBALL_NAME" ] && gensha512 "$GZ_TARBALL_NAME"
          [ -f "$ZIP_NAME" ] && gensha512 "$ZIP_NAME"

      - name: Switch to tag name
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          echo "PUBLISH_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PUBLISH_TAG_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PRE_RELEASE=false" >>"$GITHUB_ENV"

      - name: Publish artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: softprops/action-gh-release@v2.5.0
        with:
          name: ${{ env.PUBLISH_NAME }}
          tag_name: ${{ env.PUBLISH_TAG_NAME }}
          prerelease: ${{ env.PRE_RELEASE }}
          make_latest: ${{ env.MAKE_LATEST }}
          target_commitish: ${{ env.GITHUB_WORKFLOW_SHA }}
          files: |
            ${{ env.XZ_TARBALL_NAME }}
            ${{ env.XZ_TARBALL_NAME }}.sha512
            ${{ env.GZ_TARBALL_NAME }}
            ${{ env.GZ_TARBALL_NAME }}.sha512
            ${{ env.ZIP_NAME }}
            ${{ env.ZIP_NAME }}.sha512

  build-for-windows:
    name: Build for Windows
    runs-on: windows-2022 # windows-2025
    needs: [generate-product-configurations, compile]
    continue-on-error: true
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: x64
            vscode-cli-target-arch: x86_64
            env:
              RUSTFLAGS: "-Ctarget-feature=+crt-static -Clink-args=/guard:cf -Clink-args=/CETCOMPAT"
          - arch: arm64
            vscode-cli-target-arch: aarch64
            env:
              RUSTFLAGS: "-C target-feature=+crt-static -Clink-args=/guard:cf -Clink-args=/CETCOMPAT:NO"

    env:
      VSCODE_ARCH: ${{ matrix.arch }}
      APPLICATION_NAME: ${{ needs.generate-product-configurations.outputs.application-name }}
      CLI_APP_NAME: ${{ needs.generate-product-configurations.outputs.tunnel-application-name }}
      NAME_SHORT: ${{ needs.generate-product-configurations.outputs.name-short }}
      VERSION: ${{ needs.generate-product-configurations.outputs.version }}
      VSCODE_CLI_TARGET: ${{ matrix.vscode-cli-target-arch }}-pc-windows-msvc
      CARGO_NET_GIT_FETCH_WITH_CLI: true
      CFLAGS: "/guard:cf /Qspectre"
      VSCODE_CIBUILD: false

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: MeyouOSS/ATiltedTree-setup-rust@v1.0.8
        with:
          rust-version: ${{ env.RUST_VERSION }}
          targets: ${{ env.VSCODE_CLI_TARGET }}
          components: clippy

      - name: Download product configurations
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/download-artifact@v7
        with:
          name: Product configurations

      - name: Download compilation output
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/download-artifact@v7
        with:
          name: Compilation

      - name: Extract compilation output
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: tar -xJf compilation.tar.xz

      - name: Compute node modules cache key
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: compute-node-modules-cache-key
        run: echo "key=$(node build/azure-pipelines/common/computeNodeModulesCacheKey.ts win32 $VSCODE_ARCH)" >>"$GITHUB_OUTPUT"

      - name: Cache node modules
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: cache-node-modules
        uses: actions/cache@v5
        with:
          path: ".build/node_modules_cache"
          key: "NodeModules${{ steps.compute-node-modules-cache-key.outputs.key }}${{ env.CACHE_VERSION }}"

      - name: Extract node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit == 'true' }}
        run: tar -xJf .build/node_modules_cache/cache.tar.xz

      - name: Install dependencies
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          for i in {1..5}; do # try 5 times
            npm ci && break
            if [ $i -eq 5 ]; then
              echo "Npm install failed too many times" >&2
              exit 1
            fi
            echo "Npm install failed $i, trying again..."
          done
        env:
          npm_config_arch: ${{ env.VSCODE_ARCH }}
          npm_config_foreground_scripts: "true"
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Create node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p .build/node_modules_cache
          node build/azure-pipelines/common/listNodeModules.ts .build/node_modules_list.txt
          tar -cJf .build/node_modules_cache/cache.tar.xz -T .build/node_modules_list.txt

      - name: Install built-in extensions
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: ./.github/workflows/install-builtin-extensions
        with:
          cache-version: ${{ env.CACHE_VERSION }}

      - name: Generate policy definitions
        if: ${{ endsWith(github.repository, 'codeoss') && env.VSCODE_CIBUILD != true }}
        run: |
          for i in {1..3}; do # try 3 times
            (
              npm run copy-policy-dto --prefix build
              node build/lib/policies/policyGenerator.ts build/lib/policies/policyData.jsonc win32
            ) && break
            if [ "$i" -eq 3 ]; then
              exit 1
            fi
          done

      - name: Download explorer dll
        if: ${{ endsWith(github.repository, 'codeoss') && env.VSCODE_CIBUILD != true }}
        run: |
          node build/win32/explorer-dll-fetcher.ts .build/win32/appx
          cygpath -u "C:\Program Files (x86)\Windows Kits\10\bin\10.0.26100.0\x64" >>"$GITHUB_PATH"

      - name: Build client artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          echo "::group::Build binary package"
          npm run gulp vscode-win32-${VSCODE_ARCH}-min-ci
          export OPENSSL_LIB_DIR="$PWD/openssl/${VSCODE_ARCH}-windows-static/lib"
          export OPENSSL_INCLUDE_DIR="$PWD/openssl/${VSCODE_ARCH}-windows-static/include"
          (cd cli && cargo build --release --target "$VSCODE_CLI_TARGET" --bin=code)
          DEFAULT_BUILD=VSCode-win32-${VSCODE_ARCH}
          mv cli/target/"$VSCODE_CLI_TARGET"/release/code.exe ../$DEFAULT_BUILD/bin/"$CLI_APP_NAME.exe"
          BUILD=$NAME_SHORT-win32-${VSCODE_ARCH}
          (cd .. && cp -r $DEFAULT_BUILD $BUILD)
          XZ_TARBALL_NAME=$BUILD-$VERSION.tar.xz
          (cd .. && tar -cJf $XZ_TARBALL_NAME $BUILD)
          mv ../$XZ_TARBALL_NAME .
          echo "XZ_TARBALL_NAME=$XZ_TARBALL_NAME" >>"$GITHUB_ENV"
          ZIP_NAME=$BUILD-$VERSION.zip
          (cd .. && 7z a -tzip $ZIP_NAME -x!CodeSignSummary*.md $BUILD -r)
          mv ../$ZIP_NAME .
          echo "ZIP_NAME=$ZIP_NAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          npm run gulp vscode-win32-${VSCODE_ARCH}-inno-updater
          curl -L -s -o resources/win32/code.ico $CODE_ICO_URL

          echo "::group::Build system setup installer"
          npm run gulp vscode-win32-${VSCODE_ARCH}-system-setup
          SYSTEM_SETUP_NAME=${NAME_SHORT}Setup-${VSCODE_ARCH}-$VERSION.exe
          mv .build/win32-${VSCODE_ARCH}/system-setup/VSCodeSetup.exe $SYSTEM_SETUP_NAME
          echo "SYSTEM_SETUP_NAME=$SYSTEM_SETUP_NAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          echo "::group::Build user setup installer"
          npm run gulp vscode-win32-${VSCODE_ARCH}-user-setup
          USER_SETUP_NAME=${NAME_SHORT}UserSetup-${VSCODE_ARCH}-$VERSION.exe
          mv .build/win32-${VSCODE_ARCH}/user-setup/VSCodeSetup.exe $USER_SETUP_NAME
          echo "USER_SETUP_NAME=$USER_SETUP_NAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          echo "::group::Build appx package"
          APPX_NAME="$CLI_APP_NAME"
          APPX_PACKAGE_NAME="${APPX_NAME}_${VSCODE_ARCH}.appx"
          makeappx pack //d ".build/VSCode-win32-${VSCODE_ARCH}/appx/manifest" //p ".build/VSCode-win32-${VSCODE_ARCH}/appx/$APPX_PACKAGE_NAME.appx" //nv
          mv ".build/VSCode-win32-${VSCODE_ARCH}/appx/$APPX_PACKAGE_NAME.appx" .
          echo "APPX_PACKAGE_NAME=$APPX_PACKAGE_NAME" >>"$GITHUB_ENV"
          echo "::endgroup::"
        env:
          VSCODE_CLI_COMMIT: ${{ env.GITHUB_WORKFLOW_SHA }}

      - name: Build server artifacts
        if: ${{ env.VSCODE_ARCH != 'arm64' }}
        run: |
          echo "::group::Build server"
          npm run gulp vscode-reh-win32-${VSCODE_ARCH}-min-ci
          SERVER_BUILD_NAME="$APPLICATION_NAME-server-win32-${VSCODE_ARCH}"
          SERVER_XZ_TARBALL_NAME="$SERVER_BUILD_NAME.tar.xz"
          SERVER_ZIP_NAME="$SERVER_BUILD_NAME.zip"
          (cd .. && cp -r vscode-reh-win32-${VSCODE_ARCH} $SERVER_BUILD_NAME)
          (cd .. && tar -cJf $SERVER_XZ_TARBALL_NAME $SERVER_BUILD_NAME)
          mv ../$SERVER_XZ_TARBALL_NAME .
          echo "SERVER_XZ_TARBALL_NAME=$SERVER_XZ_TARBALL_NAME" >>"$GITHUB_ENV"
          (cd .. && 7z a -tzip $SERVER_ZIP_NAME $SERVER_BUILD_NAME -r)
          mv ../$SERVER_ZIP_NAME .
          echo "SERVER_ZIP_NAME=$SERVER_ZIP_NAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

          echo "::group::Build server (web)"
          npm run gulp vscode-reh-web-win32-${VSCODE_ARCH}-min-ci
          SERVER_WEB_BUILD_NAME="$APPLICATION_NAME-server-win32-${VSCODE_ARCH}-web"
          SERVER_WEB_XZ_TARBALL_NAME="$SERVER_WEB_BUILD_NAME.tar.xz"
          SERVER_WEB_ZIP_NAME="$SERVER_WEB_BUILD_NAME.zip"
          (cd .. && cp -r vscode-reh-web-win32-${VSCODE_ARCH} $SERVER_WEB_BUILD_NAME)
          (cd .. && tar -cJf $SERVER_WEB_XZ_TARBALL_NAME $SERVER_WEB_BUILD_NAME)
          mv ../$SERVER_WEB_XZ_TARBALL_NAME .
          echo "SERVER_WEB_XZ_TARBALL_NAME=$SERVER_WEB_XZ_TARBALL_NAME" >>"$GITHUB_ENV"
          (cd .. && 7z a -tzip $SERVER_WEB_ZIP_NAME $SERVER_WEB_BUILD_NAME -r)
          mv ../$SERVER_WEB_ZIP_NAME .
          echo "SERVER_WEB_ZIP_NAME=$SERVER_WEB_ZIP_NAME" >>"$GITHUB_ENV"
          echo "::endgroup::"

      - name: Generate SHA512 checksum files
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          gensha512() { (sha512sum "$1" | awk '{print $1}' >"$1".sha512); }
          [ -f "$XZ_TARBALL_NAME" ] && gensha512 "$XZ_TARBALL_NAME"
          [ -f "$ZIP_NAME" ] && gensha512 "$ZIP_NAME"
          [ -f "$SYSTEM_SETUP_NAME" ] && gensha512 "$SYSTEM_SETUP_NAME"
          [ -f "$USER_SETUP_NAME" ] && gensha512 "$USER_SETUP_NAME"
          [ -f "$APPX_PACKAGE_NAME" ] && gensha512 "$APPX_PACKAGE_NAME"
          [ -f "$SERVER_XZ_TARBALL_NAME" ] && gensha512 "$SERVER_XZ_TARBALL_NAME"
          [ -f "$SERVER_ZIP_NAME" ] && gensha512 "$SERVER_ZIP_NAME"
          [ -f "$SERVER_WEB_XZ_TARBALL_NAME" ] && gensha512 "$SERVER_WEB_XZ_TARBALL_NAME"
          ([ -f "$SERVER_WEB_ZIP_NAME" ] && gensha512 "$SERVER_WEB_ZIP_NAME") || echo >/dev/null

      - name: Switch to tag name
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          echo "PUBLISH_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PUBLISH_TAG_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PRE_RELEASE=false" >>"$GITHUB_ENV"

      - name: Publish artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: softprops/action-gh-release@v2.5.0
        with:
          name: ${{ env.PUBLISH_NAME }}
          tag_name: ${{ env.PUBLISH_TAG_NAME }}
          prerelease: ${{ env.PRE_RELEASE }}
          make_latest: ${{ env.MAKE_LATEST }}
          target_commitish: ${{ env.GITHUB_WORKFLOW_SHA }}
          files: |
            ${{ env.XZ_TARBALL_NAME }}
            ${{ env.XZ_TARBALL_NAME }}.sha512
            ${{ env.ZIP_NAME }}
            ${{ env.ZIP_NAME }}.sha512
            ${{ env.SYSTEM_SETUP_NAME }}
            ${{ env.SYSTEM_SETUP_NAME }}.sha512
            ${{ env.USER_SETUP_NAME }}
            ${{ env.USER_SETUP_NAME }}.sha512
            ${{ env.APPX_PACKAGE_NAME }}
            ${{ env.APPX_PACKAGE_NAME }}.sha512
            ${{ env.SERVER_XZ_TARBALL_NAME }}
            ${{ env.SERVER_XZ_TARBALL_NAME }}.sha512
            ${{ env.SERVER_ZIP_NAME }}
            ${{ env.SERVER_ZIP_NAME }}.sha512
            ${{ env.SERVER_WEB_XZ_TARBALL_NAME }}
            ${{ env.SERVER_WEB_XZ_TARBALL_NAME }}.sha512
            ${{ env.SERVER_WEB_ZIP_NAME }}
            ${{ env.SERVER_WEB_ZIP_NAME }}.sha512

  build-for-linux-web-standalone:
    name: Build for Linux Web (Standalone)
    runs-on: ubuntu-22.04 # ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: x64
    needs: [generate-product-configurations, compile]
    env:
      VSCODE_ARCH: x64
      APPLICATION_NAME: ${{ needs.generate-product-configurations.outputs.application-name }}

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Download product configurations
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/download-artifact@v7
        with:
          name: Product configurations

      - name: Download compilation output
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: actions/download-artifact@v7
        with:
          name: Compilation

      - name: Extract compilation output
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: tar -xJf compilation.tar.xz

      - name: Compute node modules cache key
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: compute-node-modules-cache-key
        run: echo "key=$(node build/azure-pipelines/common/computeNodeModulesCacheKey.ts web $VSCODE_ARCH)" >>"$GITHUB_OUTPUT"

      - name: Cache node modules
        if: ${{ endsWith(github.repository, 'codeoss') }}
        id: cache-node-modules
        uses: actions/cache@v5
        with:
          path: ".build/node_modules_cache"
          key: "WebNodeModules${{ steps.compute-node-modules-cache-key.outputs.key }}${{ env.CACHE_VERSION }}"

      - name: Extract node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit == 'true' }}
        run: tar -xJf .build/node_modules_cache/cache.tar.xz

      - name: Setup system services
        if: ${{ env.VSCODE_ARCH == 'x64' }}
        run: |
          ./build/azure-pipelines/linux/apt-retry.sh sudo apt-get update
          ./build/azure-pipelines/linux/apt-retry.sh sudo apt-get install -y libkrb5-dev

      - name: Install dependencies
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          for i in {1..5}; do # try 5 times
            npm ci && break
            if [ $i -eq 5 ]; then
              echo "Npm install failed too many times" >&2
              exit 1
            fi
            echo "Npm install failed $i, trying again..."
          done
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Create node modules archive
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p .build/node_modules_cache
          node build/azure-pipelines/common/listNodeModules.ts .build/node_modules_list.txt
          tar -cJf .build/node_modules_cache/cache.tar.xz -T .build/node_modules_list.txt

      - name: Install built-in extensions
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: ./.github/workflows/install-builtin-extensions
        with:
          cache-version: ${{ env.CACHE_VERSION }}

      - name: Build artifact
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          npm run gulp vscode-web-min-ci
          WEB_BUILD_NAME="$APPLICATION_NAME-web"
          WEB_XZ_TARBALL_FILENAME="$APPLICATION_NAME-web.tar.xz"
          WEB_GZ_TARBALL_FILENAME="$APPLICATION_NAME-web.tar.gz"
          (cd .. && cp -r vscode-web $WEB_BUILD_NAME)
          (cd .. && tar --owner=0 --group=0 -cJf $WEB_XZ_TARBALL_FILENAME $WEB_BUILD_NAME)
          mv ../$WEB_XZ_TARBALL_FILENAME .
          echo "WEB_XZ_TARBALL_FILENAME=$WEB_XZ_TARBALL_FILENAME" >>"$GITHUB_ENV"
          (cd .. && tar --owner=0 --group=0 -czf $WEB_GZ_TARBALL_FILENAME $WEB_BUILD_NAME)
          mv ../$WEB_GZ_TARBALL_FILENAME .
          echo "WEB_GZ_TARBALL_FILENAME=$WEB_GZ_TARBALL_FILENAME" >>"$GITHUB_ENV"

      - name: Generate SHA512 checksum files
        if: ${{ endsWith(github.repository, 'codeoss') }}
        run: |
          gensha512() { (sha512sum "$1" | awk '{print $1}' >"$1".sha512); }
          [ -f "$WEB_XZ_TARBALL_FILENAME" ] && gensha512 "$WEB_XZ_TARBALL_FILENAME"
          [ -f "$WEB_GZ_TARBALL_FILENAME" ] && gensha512 "$WEB_GZ_TARBALL_FILENAME"

      - name: Switch to tag name
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          echo "PUBLISH_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PUBLISH_TAG_NAME=${{ github.ref }}" >>"$GITHUB_ENV"
          echo "PRE_RELEASE=false" >>"$GITHUB_ENV"

      - name: Publish artifacts
        if: ${{ endsWith(github.repository, 'codeoss') }}
        uses: softprops/action-gh-release@v2.5.0
        with:
          name: ${{ env.PUBLISH_NAME }}
          tag_name: ${{ env.PUBLISH_TAG_NAME }}
          prerelease: ${{ env.PRE_RELEASE }}
          make_latest: ${{ env.MAKE_LATEST }}
          target_commitish: ${{ env.GITHUB_WORKFLOW_SHA }}
          files: |
            ${{ env.WEB_XZ_TARBALL_FILENAME }}
            ${{ env.WEB_XZ_TARBALL_FILENAME }}.sha512
            ${{ env.WEB_GZ_TARBALL_FILENAME }}
            ${{ env.WEB_GZ_TARBALL_FILENAME }}.sha512
